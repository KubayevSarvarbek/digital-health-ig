name: Update DHP Capability Statement

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:      # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-capability-statement:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Fetch Capability Statement
        run: |
          curl -sSf "https://playground.dhp.uz/fhir/metadata" | \
            jq '. + {id: "DHPCapabilityStatement"} | del(.rest[0].resource[] | select(.type == "Observation" and .supportedProfile == null))' > \
            input/vocabulary/CapabilityStatement-DHPCapabilityStatement.json

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet input/vocabulary/CapabilityStatement-DHPCapabilityStatement.json; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create or Update Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="automated/update-capability-statement"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -B "$BRANCH_NAME"
          git add input/vocabulary/CapabilityStatement-DHPCapabilityStatement.json
          git commit -m "Update DHP Capability Statement"
          git push -f origin "$BRANCH_NAME"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq '.[0].number')

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --title "Update DHP Capability Statement" \
              --body "Automated update of CapabilityStatement from playground.dhp.uz/fhir/metadata" \
              --base main \
              --head "$BRANCH_NAME"
          else
            echo "PR #$EXISTING_PR already exists and has been updated with new changes"
          fi
